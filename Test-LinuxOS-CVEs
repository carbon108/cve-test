#!/bin/sh

if [ ! "$MSCANNER_TOKEN" = "0" ] ; \
then echo "\n ---- Audit LinuxOS CVEs... ---- >" ; \
  microscanner $MSCANNER_TOKEN > microscanner.log ; \
  echo "\nExtract from ./microscanner.log for high-score CVEs..." ; \
  echo "... ... ..." ; \
  # cat microscanner.log | grep -Pzo '          "vendor_severity": "high",\n.*"vendor_statement":.*\n' ; \
  cat microscanner.log \
      | jq '.resources[]|{name: (.resource.name + " " + .resource.version), CVE: .vulnerabilities[]| select( .vendor_severity | contains("high")) | {name,  desc: .description, vendor_severity, vendor_statement, vendor_url} }'

  echo "... ... ..." ; \
  echo "Vulnerability Summary: " ; \
  cat microscanner.log | jq '.vulnerability_summary' ; \
  echo ;
fi
