#!/bin/bash

MICROSCANNER_SWITCH=$1

programName=${PWD##*/}

printf "\n ---- Test Linux CVEs... ---- > \n"

[[ ! "$MICROSCANNER_SWITCH" == "ON" ]] \
    && printf "\nMicroScanner is OFF. \nUse 'test-linux-cve ON' to run tests \n"\
    && exit

MICROSCANNER_TOKEN=${MICROSCANNER_TOKEN:-NONE}
! [[ $MICROSCANNER_TOKEN =~ ^[a-zA-Z0-9.:/*-+_=?#!~|]{15,50}$ ]] &&\
    echo '${MICROSCANNER_TOKEN} is not set or seems to be invalid. Exiting...' &&\
    exit

! command -v microscanner > /dev/null &&\
        echo "'microscanner' not found. Exiting..." &&\
        exit
! command -v jq > /dev/null &&\
        echo "'jq' JSON processor not installed. Exiting..." &&\
        exit

microscanner $MICROSCANNER_TOKEN > microscanner.log
printf "\nExtract from ./microscanner.log for high-score CVEs...\n"
echo "... ... ..."

jq_filter='.resources[]'
jq_filter+='| {'
jq_filter+='name: (.resource.name + " " + .resource.version), CVE: .vulnerabilities[]'
jq_filter+='| select( .vendor_severity | contains("high"))'
jq_filter+='| {name,  desc: .description, vendor_severity, vendor_statement, vendor_url}'
jq_filter+=' }'

cat microscanner.log | jq "$jq_filter"

echo "... ... ..."
echo "Vulnerability Summary: "
cat microscanner.log | jq '.vulnerability_summary'
echo
