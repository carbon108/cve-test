#!/bin/bash

if [ ! "$MSCANNER_TOKEN" = "0" ]
then
    printf "\n ---- Test Linux CVEs... ---- > \n"

    ! command -v jq > /dev/null &&\
        echo "'jq' not installed. Exiting..." &&\
        exit
    ! command -v microscanner > /dev/null &&\
        echo "'microscanner' not found. Exiting..." &&\
        exit

    microscanner $MSCANNER_TOKEN > microscanner.log
    printf "\nExtract from ./microscanner.log for high-score CVEs...\n"
    echo "... ... ..."

    jq_filter='.resources[]'
    jq_filter+='| {'
    jq_filter+='name: (.resource.name + " " + .resource.version), CVE: .vulnerabilities[]'
    jq_filter+='| select( .vendor_severity | contains("high"))'
    jq_filter+='| {name,  desc: .description, vendor_severity, vendor_statement, vendor_url}'
    jq_filter+=' }'

    cat microscanner.log | jq "$jq_filter"

    echo "... ... ..."
    echo "Vulnerability Summary: "
    cat microscanner.log | jq '.vulnerability_summary'
    echo
fi
